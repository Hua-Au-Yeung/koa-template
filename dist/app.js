import{DateTime as B}from"luxon";import $ from"path";import{env as c}from"process";import{createLogger as z,format as l,transports as _}from"winston";import u from"winston-daily-rotate-file";var{combine:O,timestamp:F,json:k,errors:x}=l,s=`${$.resolve()}/log`,f=e=>l((r,o)=>r.file!==void 0&&r.file===e?r:!1),a=z({level:"info",format:O(x({stack:!0}),F({format:()=>B.now().toFormat("yyyy-MM-dd HH:mm:ss")}),k()),defaultMeta:{},transports:[new u({filename:`${s}/error-%DATE%.log`,datePattern:"YYYY-w",zippedArchive:!1,maxSize:"20m",maxFiles:"30d",level:"error"}),new u({filename:`${s}/all-combined-%DATE%.log`,datePattern:"YYYY-w",zippedArchive:!0,maxSize:"20m",maxFiles:"30d",level:c.LOG_LEVEL||"debug"}),new u({filename:`${s}/http-%DATE%.log`,datePattern:"YYYY-w",zippedArchive:!1,maxSize:"20m",maxFiles:"53",level:"info",format:f("http")()}),new u({filename:`${s}/framework-%DATE%.log`,datePattern:"YYYY-w",zippedArchive:!1,maxSize:"20m",maxFiles:"53",level:"info",format:f("framework")()})]});c.NODE_ENV!=="production"&&(JSON.parse(c.DEBUG||"false")&&(a.exceptions.handle(new _.File({filename:`${s}/exception.log`})),a.rejections.handle(new _.File({filename:`${s}/rejections.log`}))),a.add(new _.Console({level:c.LOG_LEVEL||"debug",format:l.combine(l.colorize(),l.simple())})));a.exitOnError=!1;import I from"dotenv";import D from"path";import{env as Y}from"process";Y.NODE_ENV==="production"?(a.info("Loaded .env",{file:"framework"}),I.config({path:D.resolve(".env")})):(Y.NODE_ENV="develop",a.info("Loaded .env.dev",{file:"framework"}),I.config({path:D.resolve(".env.dev")}));import M from"crypto";import{DateTime as L}from"luxon";import{env as N}from"process";var b=async(e,r)=>{e.state.currentMiddleware="framework/init-request",e.state.requestId=M.randomBytes(8).toString("hex"),e.state.requestTimestamp=Date.now(),a.info(`\u{1F680} Request[ID:${e.state.requestId} Starting`,{file:"framework"});try{await r()}catch(t){let y=t;if(typeof t=="object"&&t!==null&&"status"in t&&"message"in t){let i=t;e.status=i.status||500,JSON.parse(N.DEBUG||"false")&&(i.expose=!0),i.expose&&(e.body=i.message),i.status==401&&(e.status=401,e.set("WWW-Authenticate",'Basic realm="Protected Area"'),e.body="Authentication required")}else e.status=500,JSON.parse(N.DEBUG||"false")?e.body=t:e.body=`500 Internal Server Error, ID:${e.state.requestId}
`;e.app.emit("error",y,e)}let o;switch(e.response.status.toString().substring(0,1)){case"2":case"3":o="info";break;case"4":o="warn";break;case"5":o="error";break;default:o="info"}e.set("Request-Id",e.state.requestId),a.log(o,`${e.ip} - ${e.request.method} - ${e.response.status} - ${e.request.url}`,{file:"http",requestId:e.state.requestId,ip:e.ip,timestamp:L.fromMillis(e.state.requestTimestamp).toFormat("yyyy-MM-dd HH:mm:ss"),duration:Date.now()-e.state.requestTimestamp}),a.info(`\u2705 Request[ID:${e.state.requestId} Ended`,{file:"framework"})};import H from"@koa/router";var g=new H;import q from"fs";import G from"https";import U from"koa";import{env as d}from"process";var S=d.HOST,E=parseInt(d.PORT),R=new U;R.proxy=!0;var V=["framework/init-request","framework/http-base-auth"],v=class{mainRouter=g;app=R;__construct(){}async run(){if(this.app.use(b).use(g.routes()).use(g.allowedMethods()).on("error",(r,o)=>{if(o){let t={requestId:o.state.requestId,ip:o.ip};V.includes(o.state.currentMiddleware)&&(t.file="framework"),o.status<500?a.warn(`\u26A0\uFE0F Error Event: ${r.toString().trim()}`,t):a.error(`\u274C Error Event: ${r.toString().trim()}`,t)}else a.error(`\u203C\uFE0F Global \uFE0FError Event: ${r.toString().trim()}`)}),JSON.parse(d.SSL||"false")){let r={key:q.readFileSync(d.SSL_KEY),cert:q.readFileSync(d.SSL_CERT)};G.createServer(r,this.app.callback()).listen(E,S,()=>{a.info(`HTTPS server is running on https://${S}:${E}`,{file:"framework"})})}else this.app.listen(E,S,()=>{a.info(`HTTP server is running on http://${S}:${E}`,{file:"framework"})})}},J=new v,w=J;import{env as m}from"process";import K from"winston";import C from"winston-daily-rotate-file";import j from"winston-transport-sentry-node";a.add(new C({filename:`${s}/biz-%DATE%.log`,datePattern:"YYYY-w",zippedArchive:!1,maxSize:"20m",maxFiles:"53",level:"info",format:f("biz")()}));a.add(new C({filename:`${s}/exec-%DATE%.log`,datePattern:"YYYY-w",zippedArchive:!1,maxSize:"20m",maxFiles:"53",level:"info",format:f("exec")()}));JSON.parse(m.SENTRY||"false")&&m.NODE_ENV==="production"&&JSON.parse(m.DEBUG||"false")===!1&&a.add(new j.default({sentry:{dsn:m.SENTRY_DSN},level:m.SENTRY_LOG_LEVEL,format:K.format(e=>(e.tags={NODE_ID:m.NODE_ID},e))()}));var n=a;import W from"koa-basic-auth";var A=e=>async(r,o)=>{r.state.currentMiddleware="framework/http-base-auth",await W(e)(r,o)};import re from"@koa/router";import oe from"koa-bodyparser";import{env as h}from"process";import{exec as Q}from"child_process";import{readFile as X}from"fs/promises";import Z from"path";import{env as ee}from"process";var T=e=>new Promise((r,o)=>{Q(e,(t,y,i)=>{if(t){o(t);return}if(i){o(i);return}r(y)})});var te=async()=>{try{let e=await X(Z.resolve("cmd.json"),"utf-8");return JSON.parse(e)}catch(e){return n.error("Failed to load cmd.json:",e),{}}},P=e=>{setInterval(async()=>{e.context.cmds=await te()},parseInt(ee.LOADCMDINTERVAL)||2e3)};import ae from"fs";import se from"path";var p=new re;p.use(oe());p.get("/cmd/:id",A({name:h.HTTP_BASIC_AUTH_USERNAME,pass:h.HTTP_BASIC_AUTH_PASSWORD}),async e=>{let r=e.params.id,o=e.cmds[r];if(o==null){e.status=404,e.body=`There is no such command
`;return}return T(o).then(t=>{e.body=t,n.info(t,{file:"exec",exec:{type:"cmd",cmdId:r},requestId:e.state.requestId,ip:e.ip})}).catch(t=>{n.error(t.stack,{file:"exec",exec:{type:"cmd",cmdId:r},requestId:e.state.requestId,ip:e.ip}),e.throw(500,t.message)})});p.get("/script/:name",A({name:h.HTTP_BASIC_AUTH_USERNAME,pass:h.HTTP_BASIC_AUTH_PASSWORD}),async e=>{let r=e.params.name,o=se.resolve(`./script/${r}`);if(!ae.existsSync(o)){e.status=404,e.body=`There is no such script
`;return}return T(o).then(t=>{e.body=t,n.info(t,{file:"exec",exec:{type:"script",scriptName:r},requestId:e.state.requestId,ip:e.ip})}).catch(t=>{n.error(t.stack,{file:"exec",exec:{type:"script",scriptName:r},requestId:e.state.requestId,ip:e.ip}),e.throw(500,t.message)})});(async()=>(w.mainRouter.use(p.routes(),p.allowedMethods()),await w.run(),P(w.app)))();
//# sourceMappingURL=app.js.map